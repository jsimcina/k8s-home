---
apiVersion:	operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: &name node-exporter
spec:
  staticConfigs:
    - targets:
        - nas.jonandlinz.com:9100
        - 10.10.20.1:9100
  path: /metrics
  relabelConfigs:
    - action: replace
      targetLabel: job
      replacement: *name
---
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: &name smartctl-exporter
spec:
  staticConfigs:
    - targets:
        - nas.jonandlinz.com:9633
  path: /metrics
  relabelConfigs:
    - action: replace
      targetLabel: job
      replacement: *name
---
apiVersion:	operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: &name pikvm
spec:
  staticConfigs:
    - targets:
        - pikvm.jonandlinz.com
  path: /api/export/prometheus/metrics
  relabelConfigs:
    - action: replace
      targetLabel: job
      replacement: *name
---
apiVersion:	operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: &name onepassword-connect
spec:
  staticConfigs:
    - targets:
        - nas.jonandlinz.com:7070
  path: /metrics
  relabelConfigs:
    - action: replace
      targetLabel: job
      replacement: *name
---
apiVersion:	operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: &name zigbee-controller
spec:
  staticConfigs:
    - targets:
        - 10.21.0.10
  path: /metrics
  relabelConfigs:
    - action: replace
      targetLabel: job
      replacement: *name
---
apiVersion:	operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: &name hass
spec:
  staticConfigs:
    - targets:
      - http://home-assistant.home.svc.cluster.local:8123
  path: /api/prometheus
  relabelConfigs:
    - action: replace
      targetLabel: job
      replacement: *name
  scheme: http
  bearerTokenSecret:
    name: vmetrics-secret
    key: HASS_BEARER_TOKEN
---
apiVersion:	operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: &name controld
spec:
  staticConfigs:
    - targets:
      - http://10.0.0.2:9100
  path: /metrics
  relabelConfigs:
    - action: replace
      targetLabel: job
      replacement: *name
  scheme: http
---
apiVersion:	operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: &name kubernetes-apiservers
spec:
  kubernetesSDConfigs:
    - role: endpoints
  scheme: https
  tlsConfig:
    caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    insecureSkipVerify: true
  bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
  relabelConfigs:
    - source_labels:
        [
          __meta_kubernetes_namespace,
          __meta_kubernetes_service_name,
          __meta_kubernetes_endpoint_port_name,
        ]
      action: keep
      regex: default;kubernetes;https
---
apiVersion:	operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: &name kubernetes-nodes
spec:
  kubernetesSDConfigs:
    - role: node
  scheme: https
  tlsConfig:
    caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    insecureSkipVerify: true
  bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
  relabelConfigs:
    - action: labelmap
      regex: __meta_kubernetes_node_label_(.+)
    - target_label: __address__
      replacement: kubernetes.default.svc:443
    - source_labels: [__meta_kubernetes_node_name]
      regex: (.+)
      target_label: __metrics_path__
      replacement: /api/v1/nodes/$1/proxy/metrics
---
apiVersion:	operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: &name kubernetes-nodes-cadvisor
spec:
  kubernetesSDConfigs:
    - role: node
  scheme: https
  tlsConfig:
    caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    insecureSkipVerify: true
  bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
  relabelConfigs:
    - action: labelmap
      regex: __meta_kubernetes_node_label_(.+)
    - target_label: __address__
      replacement: kubernetes.default.svc:443
    - source_labels: [__meta_kubernetes_node_name]
      regex: (.+)
      target_label: __metrics_path__
      replacement: /api/v1/nodes/$1/proxy/metrics/cadvisor
  metricRelabelConfigs:
    - action: replace
      source_labels: [pod]
      regex: '(.+)'
      target_label: pod_name
      replacement: '${1}'
    - action: replace
      source_labels: [container]
      regex: '(.+)'
      target_label: container_name
      replacement: '${1}'
    - action: replace
      target_label: name
      replacement: k8s_stub
    - action: replace
      source_labels: [id]
      regex: '^/system\.slice/(.+)\.service$'
      target_label: systemd_service_name
      replacement: '${1}'
---
apiVersion:	operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: &name kubernetes-service-endpoints
spec:
  kubernetesSDConfigs:
    - role: endpoints
  relabelConfigs:
    - action: drop
      source_labels: [__meta_kubernetes_pod_container_init]
      regex: true
    - action: keep_if_equal
      source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port, __meta_kubernetes_pod_container_port_number]
    - source_labels:
        [__meta_kubernetes_service_annotation_prometheus_io_scrape]
      action: keep
      regex: true
    - source_labels:
        [__meta_kubernetes_service_annotation_prometheus_io_scheme]
      action: replace
      target_label: __scheme__
      regex: (https?)
    - source_labels:
        [__meta_kubernetes_service_annotation_prometheus_io_path]
      action: replace
      target_label: __metrics_path__
      regex: (.+)
    - source_labels:
        [
          __address__,
          __meta_kubernetes_service_annotation_prometheus_io_port,
        ]
      action: replace
      target_label: __address__
      regex: ([^:]+)(?::\d+)?;(\d+)
      replacement: $1:$2
    - action: labelmap
      regex: __meta_kubernetes_service_label_(.+)
    - source_labels: [__meta_kubernetes_namespace]
      action: replace
      target_label: kubernetes_namespace
    - source_labels: [__meta_kubernetes_service_name]
      action: replace
      target_label: kubernetes_name
    - source_labels: [__meta_kubernetes_pod_node_name]
      action: replace
      target_label: kubernetes_node
---
apiVersion:	operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: &name kubernetes-service-endpoints-slow
spec:
  scrape_interval: 5m
  scrapeTimeout: 30s
  kubernetesSDConfigs:
    - role: endpoints
  relabelConfigs:
    - action: drop
      source_labels: [__meta_kubernetes_pod_container_init]
      regex: true
    - action: keep_if_equal
      source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port, __meta_kubernetes_pod_container_port_number]
    - source_labels:
        [__meta_kubernetes_service_annotation_prometheus_io_scrape_slow]
      action: keep
      regex: true
    - source_labels:
        [__meta_kubernetes_service_annotation_prometheus_io_scheme]
      action: replace
      target_label: __scheme__
      regex: (https?)
    - source_labels:
        [__meta_kubernetes_service_annotation_prometheus_io_path]
      action: replace
      target_label: __metrics_path__
      regex: (.+)
    - source_labels:
        [
          __address__,
          __meta_kubernetes_service_annotation_prometheus_io_port,
        ]
      action: replace
      target_label: __address__
      regex: ([^:]+)(?::\d+)?;(\d+)
      replacement: $1:$2
    - action: labelmap
      regex: __meta_kubernetes_service_label_(.+)
    - source_labels: [__meta_kubernetes_namespace]
      action: replace
      target_label: kubernetes_namespace
    - source_labels: [__meta_kubernetes_service_name]
      action: replace
      target_label: kubernetes_name
    - source_labels: [__meta_kubernetes_pod_node_name]
      action: replace
      target_label: kubernetes_node
---
apiVersion:	operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: &name kubernetes-services
spec:
  path: /probe
  params:
    module: [http_2xx]
  kubernetesSDConfigs:
    - role: service
  relabelConfigs:
    - source_labels:
        [__meta_kubernetes_service_annotation_prometheus_io_probe]
      action: keep
      regex: true
    - source_labels: [__address__]
      target_label: __param_target
    - target_label: __address__
      replacement: blackbox
    - source_labels: [__param_target]
      target_label: instance
    - action: labelmap
      regex: __meta_kubernetes_service_label_(.+)
    - source_labels: [__meta_kubernetes_namespace]
      target_label: kubernetes_namespace
    - source_labels: [__meta_kubernetes_service_name]
      target_label: kubernetes_name
---
apiVersion:	operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: &name kubernetes-pods
spec:
  kubernetesSDConfigs:
    - role: pod
  relabelConfigs:
    - action: drop
      source_labels: [__meta_kubernetes_pod_container_init]
      regex: true
    - action: keep_if_equal
      source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port, __meta_kubernetes_pod_container_port_number]
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
      action: keep
      regex: true
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
      action: replace
      target_label: __metrics_path__
      regex: (.+)
    - source_labels:
        [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
      action: replace
      regex: ([^:]+)(?::\d+)?;(\d+)
      replacement: $1:$2
      target_label: __address__
    - action: labelmap
      regex: __meta_kubernetes_pod_label_(.+)
    - source_labels: [__meta_kubernetes_namespace]
      action: replace
      target_label: kubernetes_namespace
    - source_labels: [__meta_kubernetes_pod_name]
      action: replace
      target_label: kubernetes_pod_name